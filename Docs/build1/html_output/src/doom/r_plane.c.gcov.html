<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - src_report.info - src/doom/r_plane.c</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">src/doom</a> - r_plane.c<span style="font-size: 80%;"> (source / <a href="r_plane.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">src_report.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">3</td>
            <td class="headerCovTableEntry">288</td>
            <td class="headerCovTableEntryLo">1.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2022-06-05 12:05:30</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">7</td>
            <td class="headerCovTableEntryLo">14.3 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : //</a>
<span class="lineNum">       2 </span>            : // Copyright(C) 1993-1996 Id Software, Inc.
<span class="lineNum">       3 </span>            : // Copyright(C) 2005-2014 Simon Howard
<span class="lineNum">       4 </span>            : //
<span class="lineNum">       5 </span>            : // This program is free software; you can redistribute it and/or
<span class="lineNum">       6 </span>            : // modify it under the terms of the GNU General Public License
<span class="lineNum">       7 </span>            : // as published by the Free Software Foundation; either version 2
<span class="lineNum">       8 </span>            : // of the License, or (at your option) any later version.
<span class="lineNum">       9 </span>            : //
<span class="lineNum">      10 </span>            : // This program is distributed in the hope that it will be useful,
<span class="lineNum">      11 </span>            : // but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      12 </span>            : // MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<span class="lineNum">      13 </span>            : // GNU General Public License for more details.
<span class="lineNum">      14 </span>            : //
<span class="lineNum">      15 </span>            : // DESCRIPTION:
<span class="lineNum">      16 </span>            : //      Here is a core component: drawing the floors and ceilings,
<span class="lineNum">      17 </span>            : //       while maintaining a per column clipping list only.
<span class="lineNum">      18 </span>            : //      Moreover, the sky areas have to be determined.
<span class="lineNum">      19 </span>            : //
<span class="lineNum">      20 </span>            : 
<span class="lineNum">      21 </span>            : 
<span class="lineNum">      22 </span>            : #include &lt;stdio.h&gt;
<span class="lineNum">      23 </span>            : #include &lt;stdlib.h&gt;
<span class="lineNum">      24 </span>            : 
<span class="lineNum">      25 </span>            : #include &quot;i_system.h&quot;
<span class="lineNum">      26 </span>            : #include &quot;z_zone.h&quot;
<span class="lineNum">      27 </span>            : #include &quot;w_wad.h&quot;
<span class="lineNum">      28 </span>            : 
<span class="lineNum">      29 </span>            : #include &quot;doomdef.h&quot;
<span class="lineNum">      30 </span>            : #include &quot;doomstat.h&quot;
<span class="lineNum">      31 </span>            : 
<span class="lineNum">      32 </span>            : #include &quot;r_local.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;r_sky.h&quot;
<span class="lineNum">      34 </span>            : 
<span class="lineNum">      35 </span>            : 
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span>            : planefunction_t         floorfunc;
<span class="lineNum">      38 </span>            : planefunction_t         ceilingfunc;
<span class="lineNum">      39 </span>            : 
<span class="lineNum">      40 </span>            : //
<span class="lineNum">      41 </span>            : // opening
<span class="lineNum">      42 </span>            : //
<span class="lineNum">      43 </span>            : 
<span class="lineNum">      44 </span>            : // Here comes the obnoxious &quot;visplane&quot;.
<span class="lineNum">      45 </span><span class="lineNoCov">          0 : #define MAXVISPLANES    128</span>
<span class="lineNum">      46 </span>            : visplane_t              visplanes[MAXVISPLANES];
<span class="lineNum">      47 </span>            : visplane_t*             lastvisplane;
<span class="lineNum">      48 </span>            : visplane_t*             floorplane;
<span class="lineNum">      49 </span>            : visplane_t*             ceilingplane;
<span class="lineNum">      50 </span>            : 
<span class="lineNum">      51 </span>            : // ?
<span class="lineNum">      52 </span><span class="lineNoCov">          0 : #define MAXOPENINGS     SCREENWIDTH*64</span>
<span class="lineNum">      53 </span>            : short                   openings[MAXOPENINGS];
<span class="lineNum">      54 </span>            : short*                  lastopening;
<span class="lineNum">      55 </span>            : 
<span class="lineNum">      56 </span>            : 
<span class="lineNum">      57 </span>            : //
<span class="lineNum">      58 </span>            : // Clip values are the solid pixel bounding the range.
<span class="lineNum">      59 </span>            : //  floorclip starts out SCREENHEIGHT
<span class="lineNum">      60 </span>            : //  ceilingclip starts out -1
<span class="lineNum">      61 </span>            : //
<span class="lineNum">      62 </span>            : short                   floorclip[SCREENWIDTH];
<span class="lineNum">      63 </span>            : short                   ceilingclip[SCREENWIDTH];
<span class="lineNum">      64 </span>            : 
<span class="lineNum">      65 </span>            : //
<span class="lineNum">      66 </span>            : // spanstart holds the start of a plane span
<span class="lineNum">      67 </span>            : // initialized to 0 at start
<span class="lineNum">      68 </span>            : //
<span class="lineNum">      69 </span>            : int                     spanstart[SCREENHEIGHT];
<span class="lineNum">      70 </span>            : int                     spanstop[SCREENHEIGHT];
<span class="lineNum">      71 </span>            : 
<span class="lineNum">      72 </span>            : //
<span class="lineNum">      73 </span>            : // texture mapping
<span class="lineNum">      74 </span>            : //
<span class="lineNum">      75 </span>            : lighttable_t**          planezlight;
<span class="lineNum">      76 </span>            : fixed_t                 planeheight;
<span class="lineNum">      77 </span>            : 
<span class="lineNum">      78 </span>            : fixed_t                 yslope[SCREENHEIGHT];
<span class="lineNum">      79 </span>            : fixed_t                 distscale[SCREENWIDTH];
<span class="lineNum">      80 </span>            : fixed_t                 basexscale;
<span class="lineNum">      81 </span>            : fixed_t                 baseyscale;
<span class="lineNum">      82 </span>            : 
<span class="lineNum">      83 </span>            : fixed_t                 cachedheight[SCREENHEIGHT];
<span class="lineNum">      84 </span>            : fixed_t                 cacheddistance[SCREENHEIGHT];
<span class="lineNum">      85 </span>            : fixed_t                 cachedxstep[SCREENHEIGHT];
<span class="lineNum">      86 </span>            : fixed_t                 cachedystep[SCREENHEIGHT];
<span class="lineNum">      87 </span>            : 
<span class="lineNum">      88 </span>            : 
<span class="lineNum">      89 </span>            : 
<span class="lineNum">      90 </span>            : //
<span class="lineNum">      91 </span>            : // R_InitPlanes
<span class="lineNum">      92 </span>            : // Only at game startup.
<a name="93"><span class="lineNum">      93 </span>            : //</a>
<span class="lineNum">      94 </span>            : void R_InitPlanes (void)
<span class="lineNum">      95 </span><span class="lineCov">       5556 : {</span>
<span class="lineNum">      96 </span><span class="lineCov">       5556 :   // Doh!</span>
<span class="lineNum">      97 </span><span class="lineCov">       5556 : }</span>
<span class="lineNum">      98 </span>            : 
<span class="lineNum">      99 </span>            : 
<span class="lineNum">     100 </span>            : //
<span class="lineNum">     101 </span>            : // R_MapPlane
<span class="lineNum">     102 </span>            : //
<span class="lineNum">     103 </span>            : // Uses global vars:
<span class="lineNum">     104 </span>            : //  planeheight
<span class="lineNum">     105 </span>            : //  ds_source
<span class="lineNum">     106 </span>            : //  basexscale
<span class="lineNum">     107 </span>            : //  baseyscale
<span class="lineNum">     108 </span>            : //  viewx
<span class="lineNum">     109 </span>            : //  viewy
<span class="lineNum">     110 </span>            : //
<span class="lineNum">     111 </span>            : // BASIC PRIMITIVE
<span class="lineNum">     112 </span>            : //
<span class="lineNum">     113 </span>            : void
<span class="lineNum">     114 </span>            : R_MapPlane
<span class="lineNum">     115 </span>            : ( int           y,
<a name="116"><span class="lineNum">     116 </span>            :   int           x1,</a>
<span class="lineNum">     117 </span>            :   int           x2 )
<span class="lineNum">     118 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :     angle_t     angle;</span>
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :     fixed_t     distance;</span>
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :     fixed_t     length;</span>
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :     unsigned    index;</span>
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :         </span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 : #ifdef RANGECHECK</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :     if (x2 &lt; x1</span>
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :      || x1 &lt; 0</span>
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :      || x2 &gt;= viewwidth</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :      || y &gt; viewheight)</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :         I_Error (&quot;R_MapPlane: %i, %i at %i&quot;,x1,x2,y);</span>
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     132 </span><span class="lineNoCov">          0 : #endif</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     134 </span><span class="lineNoCov">          0 :     if (planeheight != cachedheight[y])</span>
<span class="lineNum">     135 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :         cachedheight[y] = planeheight;</span>
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :         distance = cacheddistance[y] = FixedMul (planeheight, yslope[y]);</span>
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :         ds_xstep = cachedxstep[y] = FixedMul (distance,basexscale);</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :         ds_ystep = cachedystep[y] = FixedMul (distance,baseyscale);</span>
<span class="lineNum">     140 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :     else</span>
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     143 </span><span class="lineNoCov">          0 :         distance = cacheddistance[y];</span>
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :         ds_xstep = cachedxstep[y];</span>
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :         ds_ystep = cachedystep[y];</span>
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :         </span>
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :     length = FixedMul (distance,distscale[x1]);</span>
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :     angle = (viewangle + xtoviewangle[x1])&gt;&gt;ANGLETOFINESHIFT;</span>
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :     ds_xfrac = viewx + FixedMul(finecosine[angle], length);</span>
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :     ds_yfrac = -viewy - FixedMul(finesine[angle], length);</span>
<span class="lineNum">     152 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :     if (fixedcolormap)</span>
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :         ds_colormap = fixedcolormap;</span>
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :     else</span>
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :         index = distance &gt;&gt; LIGHTZSHIFT;</span>
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :         </span>
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :         if (index &gt;= MAXLIGHTZ )</span>
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :             index = MAXLIGHTZ-1;</span>
<span class="lineNum">     161 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :         ds_colormap = planezlight[index];</span>
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :         </span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :     ds_y = y;</span>
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :     ds_x1 = x1;</span>
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :     ds_x2 = x2;</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :     // high or low detail</span>
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :     spanfunc ();        </span>
<span class="lineNum">     171 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     172 </span>            : 
<span class="lineNum">     173 </span>            : 
<span class="lineNum">     174 </span>            : //
<span class="lineNum">     175 </span>            : // R_ClearPlanes
<span class="lineNum">     176 </span>            : // At begining of frame.
<a name="177"><span class="lineNum">     177 </span>            : //</a>
<span class="lineNum">     178 </span>            : void R_ClearPlanes (void)
<span class="lineNum">     179 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :     int         i;</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :     angle_t     angle;</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :     </span>
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :     // opening / clipping determination</span>
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :     for (i=0 ; i&lt;viewwidth ; i++)</span>
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :         floorclip[i] = viewheight;</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :         ceilingclip[i] = -1;</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :     lastvisplane = visplanes;</span>
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :     lastopening = openings;</span>
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :     </span>
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :     // texture calculation</span>
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :     memset (cachedheight, 0, sizeof(cachedheight));</span>
<span class="lineNum">     195 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :     // left to right mapping</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :     angle = (viewangle-ANG90)&gt;&gt;ANGLETOFINESHIFT;</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :         </span>
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :     // scale will be unit scale at SCREENWIDTH/2 distance</span>
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :     basexscale = FixedDiv (finecosine[angle],centerxfrac);</span>
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :     baseyscale = -FixedDiv (finesine[angle],centerxfrac);</span>
<span class="lineNum">     202 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     203 </span>            : 
<span class="lineNum">     204 </span>            : 
<span class="lineNum">     205 </span>            : 
<span class="lineNum">     206 </span>            : 
<span class="lineNum">     207 </span>            : //
<span class="lineNum">     208 </span>            : // R_FindPlane
<span class="lineNum">     209 </span>            : //
<span class="lineNum">     210 </span>            : visplane_t*
<span class="lineNum">     211 </span>            : R_FindPlane
<span class="lineNum">     212 </span>            : ( fixed_t       height,
<a name="213"><span class="lineNum">     213 </span>            :   int           picnum,</a>
<span class="lineNum">     214 </span>            :   int           lightlevel )
<span class="lineNum">     215 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :     visplane_t* check;</span>
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :         </span>
<span class="lineNum">     218 </span><span class="lineNoCov">          0 :     if (picnum == skyflatnum)</span>
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :         height = 0;                     // all skys map together</span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :         lightlevel = 0;</span>
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :         </span>
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :     for (check=visplanes; check&lt;lastvisplane; check++)</span>
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :         if (height == check-&gt;height</span>
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :             &amp;&amp; picnum == check-&gt;picnum</span>
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :             &amp;&amp; lightlevel == check-&gt;lightlevel)</span>
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :         {</span>
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     233 </span><span class="lineNoCov">          0 :     </span>
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :                         </span>
<span class="lineNum">     235 </span><span class="lineNoCov">          0 :     if (check &lt; lastvisplane)</span>
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :         return check;</span>
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :                 </span>
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :     if (lastvisplane - visplanes == MAXVISPLANES)</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :         I_Error (&quot;R_FindPlane: no more visplanes&quot;);</span>
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :                 </span>
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :     lastvisplane++;</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :     check-&gt;height = height;</span>
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :     check-&gt;picnum = picnum;</span>
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :     check-&gt;lightlevel = lightlevel;</span>
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :     check-&gt;minx = SCREENWIDTH;</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :     check-&gt;maxx = -1;</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :     </span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :     memset (check-&gt;top,0xff,sizeof(check-&gt;top));</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :                 </span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :     return check;</span>
<span class="lineNum">     252 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     253 </span>            : 
<span class="lineNum">     254 </span>            : 
<span class="lineNum">     255 </span>            : //
<span class="lineNum">     256 </span>            : // R_CheckPlane
<span class="lineNum">     257 </span>            : //
<span class="lineNum">     258 </span>            : visplane_t*
<span class="lineNum">     259 </span>            : R_CheckPlane
<span class="lineNum">     260 </span>            : ( visplane_t*   pl,
<a name="261"><span class="lineNum">     261 </span>            :   int           start,</a>
<span class="lineNum">     262 </span>            :   int           stop )
<span class="lineNum">     263 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :     int         intrl;</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :     int         intrh;</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :     int         unionl;</span>
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :     int         unionh;</span>
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :     int         x;</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :         </span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :     if (start &lt; pl-&gt;minx)</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :         intrl = pl-&gt;minx;</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :         unionl = start;</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :     else</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :         unionl = pl-&gt;minx;</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :         intrl = start;</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :         </span>
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :     if (stop &gt; pl-&gt;maxx)</span>
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :         intrh = pl-&gt;maxx;</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :         unionh = stop;</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :     else</span>
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :         unionh = pl-&gt;maxx;</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :         intrh = stop;</span>
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     291 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :     for (x=intrl ; x&lt;= intrh ; x++)</span>
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :         if (pl-&gt;top[x] != 0xff)</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :     if (x &gt; intrh)</span>
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :         pl-&gt;minx = unionl;</span>
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :         pl-&gt;maxx = unionh;</span>
<span class="lineNum">     300 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :         // use the same one</span>
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :         return pl;              </span>
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :         </span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :     // make a new visplane</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :     lastvisplane-&gt;height = pl-&gt;height;</span>
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :     lastvisplane-&gt;picnum = pl-&gt;picnum;</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :     lastvisplane-&gt;lightlevel = pl-&gt;lightlevel;</span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :     </span>
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :     if (lastvisplane - visplanes == MAXVISPLANES)</span>
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :         I_Error (&quot;R_CheckPlane: no more visplanes&quot;);</span>
<span class="lineNum">     312 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :     pl = lastvisplane++;</span>
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :     pl-&gt;minx = start;</span>
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :     pl-&gt;maxx = stop;</span>
<span class="lineNum">     316 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :     memset (pl-&gt;top,0xff,sizeof(pl-&gt;top));</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :                 </span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :     return pl;</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     321 </span>            : 
<span class="lineNum">     322 </span>            : 
<span class="lineNum">     323 </span>            : //
<span class="lineNum">     324 </span>            : // R_MakeSpans
<span class="lineNum">     325 </span>            : //
<span class="lineNum">     326 </span>            : void
<span class="lineNum">     327 </span>            : R_MakeSpans
<span class="lineNum">     328 </span>            : ( int           x,
<span class="lineNum">     329 </span>            :   int           t1,
<span class="lineNum">     330 </span>            :   int           b1,
<a name="331"><span class="lineNum">     331 </span>            :   int           t2,</a>
<span class="lineNum">     332 </span>            :   int           b2 )
<span class="lineNum">     333 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :     while (t1 &lt; t2 &amp;&amp; t1&lt;=b1)</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :         R_MapPlane (t1,spanstart[t1],x-1);</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :         t1++;</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :     while (b1 &gt; b2 &amp;&amp; b1&gt;=t1)</span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :         R_MapPlane (b1,spanstart[b1],x-1);</span>
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :         b1--;</span>
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :         </span>
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :     while (t2 &lt; t1 &amp;&amp; t2&lt;=b2)</span>
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :         spanstart[t2] = x;</span>
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :         t2++;</span>
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :     while (b2 &gt; b1 &amp;&amp; b2&gt;=t2)</span>
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :         spanstart[b2] = x;</span>
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :         b2--;</span>
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     356 </span>            : 
<span class="lineNum">     357 </span>            : 
<span class="lineNum">     358 </span>            : 
<span class="lineNum">     359 </span>            : //
<span class="lineNum">     360 </span>            : // R_DrawPlanes
<span class="lineNum">     361 </span>            : // At the end of each frame.
<a name="362"><span class="lineNum">     362 </span>            : //</a>
<span class="lineNum">     363 </span>            : void R_DrawPlanes (void)
<span class="lineNum">     364 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :     visplane_t*         pl;</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :     int                 light;</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :     int                 x;</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :     int                 stop;</span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :     int                 angle;</span>
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :     int                 lumpnum;</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :                                 </span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 : #ifdef RANGECHECK</span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :     if (ds_p - drawsegs &gt; MAXDRAWSEGS)</span>
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :         I_Error (&quot;R_DrawPlanes: drawsegs overflow (%&quot; PRIiPTR &quot;)&quot;,</span>
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :                  ds_p - drawsegs);</span>
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :     </span>
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :     if (lastvisplane - visplanes &gt; MAXVISPLANES)</span>
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :         I_Error (&quot;R_DrawPlanes: visplane overflow (%&quot; PRIiPTR &quot;)&quot;,</span>
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :                  lastvisplane - visplanes);</span>
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :     </span>
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :     if (lastopening - openings &gt; MAXOPENINGS)</span>
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :         I_Error (&quot;R_DrawPlanes: opening overflow (%&quot; PRIiPTR &quot;)&quot;,</span>
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :                  lastopening - openings);</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 : #endif</span>
<span class="lineNum">     385 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :     for (pl = visplanes ; pl &lt; lastvisplane ; pl++)</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :         if (pl-&gt;minx &gt; pl-&gt;maxx)</span>
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     390 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :         </span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :         // sky flat</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :         if (pl-&gt;picnum == skyflatnum)</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :         {</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :             dc_iscale = pspriteiscale&gt;&gt;detailshift;</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :             </span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :             // Sky is allways drawn full bright,</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :             //  i.e. colormaps[0] is used.</span>
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :             // Because of this hack, sky is not affected</span>
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :             //  by INVUL inverse mapping.</span>
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :             dc_colormap = colormaps;</span>
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :             dc_texturemid = skytexturemid;</span>
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :             for (x=pl-&gt;minx ; x &lt;= pl-&gt;maxx ; x++)</span>
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :             {</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :                 dc_yl = pl-&gt;top[x];</span>
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :                 dc_yh = pl-&gt;bottom[x];</span>
<span class="lineNum">     407 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :                 if (dc_yl &lt;= dc_yh)</span>
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :                 {</span>
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :                     angle = (viewangle + xtoviewangle[x])&gt;&gt;ANGLETOSKYSHIFT;</span>
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :                     dc_x = x;</span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :                     dc_source = R_GetColumn(skytexture, angle);</span>
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :                     colfunc ();</span>
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :         </span>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :         // regular flat</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :         lumpnum = firstflat + flattranslation[pl-&gt;picnum];</span>
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :         ds_source = W_CacheLumpNum(lumpnum, PU_STATIC);</span>
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :         </span>
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :         planeheight = abs(pl-&gt;height-viewz);</span>
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :         light = (pl-&gt;lightlevel &gt;&gt; LIGHTSEGSHIFT)+extralight;</span>
<span class="lineNum">     425 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :         if (light &gt;= LIGHTLEVELS)</span>
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :             light = LIGHTLEVELS-1;</span>
<span class="lineNum">     428 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :         if (light &lt; 0)</span>
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :             light = 0;</span>
<span class="lineNum">     431 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :         planezlight = zlight[light];</span>
<span class="lineNum">     433 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :         pl-&gt;top[pl-&gt;maxx+1] = 0xff;</span>
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :         pl-&gt;top[pl-&gt;minx-1] = 0xff;</span>
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :                 </span>
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :         stop = pl-&gt;maxx + 1;</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :         for (x=pl-&gt;minx ; x&lt;= stop ; x++)</span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :         {</span>
<span class="lineNum">     441 </span><span class="lineNoCov">          0 :             R_MakeSpans(x,pl-&gt;top[x-1],</span>
<span class="lineNum">     442 </span><span class="lineNoCov">          0 :                         pl-&gt;bottom[x-1],</span>
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :                         pl-&gt;top[x],</span>
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :                         pl-&gt;bottom[x]);</span>
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :         </span>
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :         W_ReleaseLumpNum(lumpnum);</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     449 </span><span class="lineNoCov">          0 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
