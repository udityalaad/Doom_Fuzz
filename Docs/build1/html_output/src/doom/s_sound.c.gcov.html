<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - src_report.info - src/doom/s_sound.c</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">src/doom</a> - s_sound.c<span style="font-size: 80%;"> (source / <a href="s_sound.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">src_report.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">120</td>
            <td class="headerCovTableEntry">547</td>
            <td class="headerCovTableEntryLo">21.9 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2022-06-05 12:05:30</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">7</td>
            <td class="headerCovTableEntry">18</td>
            <td class="headerCovTableEntryLo">38.9 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : //</a>
<span class="lineNum">       2 </span>            : // Copyright(C) 1993-1996 Id Software, Inc.
<span class="lineNum">       3 </span>            : // Copyright(C) 2005-2014 Simon Howard
<span class="lineNum">       4 </span>            : //
<span class="lineNum">       5 </span>            : // This program is free software; you can redistribute it and/or
<span class="lineNum">       6 </span>            : // modify it under the terms of the GNU General Public License
<span class="lineNum">       7 </span>            : // as published by the Free Software Foundation; either version 2
<span class="lineNum">       8 </span>            : // of the License, or (at your option) any later version.
<span class="lineNum">       9 </span>            : //
<span class="lineNum">      10 </span>            : // This program is distributed in the hope that it will be useful,
<span class="lineNum">      11 </span>            : // but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      12 </span>            : // MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<span class="lineNum">      13 </span>            : // GNU General Public License for more details.
<span class="lineNum">      14 </span>            : //
<span class="lineNum">      15 </span>            : // DESCRIPTION:  none
<span class="lineNum">      16 </span>            : //
<span class="lineNum">      17 </span>            : 
<span class="lineNum">      18 </span>            : #include &lt;stdio.h&gt;
<span class="lineNum">      19 </span>            : #include &lt;stdlib.h&gt;
<span class="lineNum">      20 </span>            : 
<span class="lineNum">      21 </span>            : #include &quot;i_sound.h&quot;
<span class="lineNum">      22 </span>            : #include &quot;i_system.h&quot;
<span class="lineNum">      23 </span>            : 
<span class="lineNum">      24 </span>            : #include &quot;deh_str.h&quot;
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            : #include &quot;doomstat.h&quot;
<span class="lineNum">      27 </span>            : #include &quot;doomtype.h&quot;
<span class="lineNum">      28 </span>            : 
<span class="lineNum">      29 </span>            : #include &quot;sounds.h&quot;
<span class="lineNum">      30 </span>            : #include &quot;s_sound.h&quot;
<span class="lineNum">      31 </span>            : 
<span class="lineNum">      32 </span>            : #include &quot;m_misc.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;m_random.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;m_argv.h&quot;
<span class="lineNum">      35 </span>            : 
<span class="lineNum">      36 </span>            : #include &quot;p_local.h&quot;
<span class="lineNum">      37 </span>            : #include &quot;w_wad.h&quot;
<span class="lineNum">      38 </span>            : #include &quot;z_zone.h&quot;
<span class="lineNum">      39 </span>            : 
<span class="lineNum">      40 </span>            : // when to clip out sounds
<span class="lineNum">      41 </span>            : // Does not fit the large outdoor areas.
<span class="lineNum">      42 </span>            : 
<span class="lineNum">      43 </span><span class="lineNoCov">          0 : #define S_CLIPPING_DIST (1200 * FRACUNIT)</span>
<span class="lineNum">      44 </span>            : 
<span class="lineNum">      45 </span>            : // Distance tp origin when sounds should be maxed out.
<span class="lineNum">      46 </span>            : // This should relate to movement clipping resolution
<span class="lineNum">      47 </span>            : // (see BLOCKMAP handling).
<span class="lineNum">      48 </span>            : // In the source code release: (160*FRACUNIT).  Changed back to the
<span class="lineNum">      49 </span>            : // Vanilla value of 200 (why was this changed?)
<span class="lineNum">      50 </span>            : 
<span class="lineNum">      51 </span><span class="lineNoCov">          0 : #define S_CLOSE_DIST (200 * FRACUNIT)</span>
<span class="lineNum">      52 </span>            : 
<span class="lineNum">      53 </span>            : // The range over which sound attenuates
<span class="lineNum">      54 </span>            : 
<span class="lineNum">      55 </span><span class="lineNoCov">          0 : #define S_ATTENUATOR ((S_CLIPPING_DIST - S_CLOSE_DIST) &gt;&gt; FRACBITS)</span>
<span class="lineNum">      56 </span>            : 
<span class="lineNum">      57 </span>            : // Stereo separation
<span class="lineNum">      58 </span>            : 
<span class="lineNum">      59 </span><span class="lineNoCov">          0 : #define S_STEREO_SWING (96 * FRACUNIT)</span>
<span class="lineNum">      60 </span>            : 
<span class="lineNum">      61 </span>            : #define NORM_PRIORITY 64
<span class="lineNum">      62 </span><span class="lineNoCov">          0 : #define NORM_SEP 128</span>
<span class="lineNum">      63 </span>            : 
<span class="lineNum">      64 </span>            : typedef struct
<span class="lineNum">      65 </span>            : {
<span class="lineNum">      66 </span>            :     // sound information (if null, channel avail.)
<span class="lineNum">      67 </span>            :     sfxinfo_t *sfxinfo;
<span class="lineNum">      68 </span>            : 
<span class="lineNum">      69 </span>            :     // origin of sound
<span class="lineNum">      70 </span>            :     mobj_t *origin;
<span class="lineNum">      71 </span>            : 
<span class="lineNum">      72 </span>            :     // handle of the sound being played
<span class="lineNum">      73 </span>            :     int handle;
<span class="lineNum">      74 </span>            : 
<span class="lineNum">      75 </span>            :     int pitch;
<span class="lineNum">      76 </span>            : 
<span class="lineNum">      77 </span>            : } channel_t;
<span class="lineNum">      78 </span>            : 
<span class="lineNum">      79 </span>            : // The set of channels available
<span class="lineNum">      80 </span>            : 
<span class="lineNum">      81 </span>            : static channel_t *channels;
<span class="lineNum">      82 </span>            : 
<span class="lineNum">      83 </span>            : // Maximum volume of a sound effect.
<span class="lineNum">      84 </span>            : // Internal default is max out of 0-15.
<span class="lineNum">      85 </span>            : 
<span class="lineNum">      86 </span>            : int sfxVolume = 8;
<span class="lineNum">      87 </span>            : 
<span class="lineNum">      88 </span>            : // Maximum volume of music.
<span class="lineNum">      89 </span>            : 
<span class="lineNum">      90 </span>            : int musicVolume = 8;
<span class="lineNum">      91 </span>            : 
<span class="lineNum">      92 </span>            : // Internal volume level, ranging from 0-127
<span class="lineNum">      93 </span>            : 
<span class="lineNum">      94 </span>            : static int snd_SfxVolume;
<span class="lineNum">      95 </span>            : 
<span class="lineNum">      96 </span>            : // Whether songs are mus_paused
<span class="lineNum">      97 </span>            : 
<span class="lineNum">      98 </span>            : static boolean mus_paused;
<span class="lineNum">      99 </span>            : 
<span class="lineNum">     100 </span>            : // Music currently being played
<span class="lineNum">     101 </span>            : 
<span class="lineNum">     102 </span>            : static musicinfo_t *mus_playing = NULL;
<span class="lineNum">     103 </span>            : 
<span class="lineNum">     104 </span>            : // Number of channels to use
<span class="lineNum">     105 </span>            : 
<span class="lineNum">     106 </span>            : int snd_channels = 8;
<span class="lineNum">     107 </span>            : 
<span class="lineNum">     108 </span>            : //
<span class="lineNum">     109 </span>            : // Initializes sound stuff, including volume
<span class="lineNum">     110 </span>            : // Sets channels, SFX and music volume,
<span class="lineNum">     111 </span>            : //  allocates channel buffer, sets S_sfx lookup.
<span class="lineNum">     112 </span>            : //
<a name="113"><span class="lineNum">     113 </span>            : </a>
<span class="lineNum">     114 </span>            : void S_Init(int sfxVolume, int musicVolume)
<span class="lineNum">     115 </span><span class="lineCov">       5494 : {</span>
<span class="lineNum">     116 </span><span class="lineCov">       5494 :     int i;</span>
<span class="lineNum">     117 </span><span class="lineCov">       5494 : </span>
<span class="lineNum">     118 </span><span class="lineCov">       5494 :     if (gameversion == exe_doom_1_666)</span>
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :         if (logical_gamemission == doom)</span>
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :         {</span>
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :             I_SetOPLDriverVer(opl_doom1_1_666);</span>
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :         else</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :         {</span>
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :             I_SetOPLDriverVer(opl_doom2_1_666);</span>
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     129 </span><span class="lineCov">       5494 :     else</span>
<span class="lineNum">     130 </span><span class="lineCov">       5494 :     {</span>
<span class="lineNum">     131 </span><span class="lineCov">       5494 :         I_SetOPLDriverVer(opl_doom_1_9);</span>
<span class="lineNum">     132 </span><span class="lineCov">       5494 :     }</span>
<span class="lineNum">     133 </span><span class="lineCov">       5494 : </span>
<span class="lineNum">     134 </span><span class="lineCov">       5494 :     I_PrecacheSounds(S_sfx, NUMSFX);</span>
<span class="lineNum">     135 </span><span class="lineCov">       5494 : </span>
<span class="lineNum">     136 </span><span class="lineCov">       5494 :     S_SetSfxVolume(sfxVolume);</span>
<span class="lineNum">     137 </span><span class="lineCov">       5494 :     S_SetMusicVolume(musicVolume);</span>
<span class="lineNum">     138 </span><span class="lineCov">       5494 : </span>
<span class="lineNum">     139 </span><span class="lineCov">       5494 :     // Allocating the internal channels for mixing</span>
<span class="lineNum">     140 </span><span class="lineCov">       5494 :     // (the maximum numer of sounds rendered</span>
<span class="lineNum">     141 </span><span class="lineCov">       5494 :     // simultaneously) within zone memory.</span>
<span class="lineNum">     142 </span><span class="lineCov">       5494 :     channels = Z_Malloc(snd_channels*sizeof(channel_t), PU_STATIC, 0);</span>
<span class="lineNum">     143 </span><span class="lineCov">       5494 : </span>
<span class="lineNum">     144 </span><span class="lineCov">       5494 :     // Free all channels for use</span>
<span class="lineNum">     145 </span><span class="lineCov">      49446 :     for (i=0 ; i&lt;snd_channels ; i++)</span>
<span class="lineNum">     146 </span><span class="lineCov">      43952 :     {</span>
<span class="lineNum">     147 </span><span class="lineCov">      43952 :         channels[i].sfxinfo = 0;</span>
<span class="lineNum">     148 </span><span class="lineCov">      43952 :     }</span>
<span class="lineNum">     149 </span><span class="lineCov">       5494 : </span>
<span class="lineNum">     150 </span><span class="lineCov">       5494 :     // no sounds are playing, and they are not mus_paused</span>
<span class="lineNum">     151 </span><span class="lineCov">       5494 :     mus_paused = 0;</span>
<span class="lineNum">     152 </span><span class="lineCov">       5494 : </span>
<span class="lineNum">     153 </span><span class="lineCov">       5494 :     // Note that sounds have not been cached (yet).</span>
<span class="lineNum">     154 </span><span class="lineCov">     598846 :     for (i=1 ; i&lt;NUMSFX ; i++)</span>
<span class="lineNum">     155 </span><span class="lineCov">     593352 :     {</span>
<span class="lineNum">     156 </span><span class="lineCov">     593352 :         S_sfx[i].lumpnum = S_sfx[i].usefulness = -1;</span>
<span class="lineNum">     157 </span><span class="lineCov">     593352 :     }</span>
<span class="lineNum">     158 </span><span class="lineCov">       5494 : </span>
<span class="lineNum">     159 </span><span class="lineCov">       5494 :     // Doom defaults to pitch-shifting off.</span>
<span class="lineNum">     160 </span><span class="lineCov">       5494 :     if (snd_pitchshift == -1)</span>
<span class="lineNum">     161 </span><span class="lineCov">          1 :     {</span>
<span class="lineNum">     162 </span><span class="lineCov">          1 :         snd_pitchshift = 0;</span>
<span class="lineNum">     163 </span><span class="lineCov">          1 :     }</span>
<span class="lineNum">     164 </span><span class="lineCov">       5494 : </span>
<span class="lineNum">     165 </span><span class="lineCov">       5494 :     I_AtExit(S_Shutdown, true);</span>
<span class="lineNum">     166 </span><span class="lineCov">       5494 : }</span>
<a name="167"><span class="lineNum">     167 </span>            : </a>
<span class="lineNum">     168 </span>            : void S_Shutdown(void)
<span class="lineNum">     169 </span><span class="lineCov">     379926 : {</span>
<span class="lineNum">     170 </span><span class="lineCov">     379926 :     I_ShutdownSound();</span>
<span class="lineNum">     171 </span><span class="lineCov">     379926 :     I_ShutdownMusic();</span>
<span class="lineNum">     172 </span><span class="lineCov">     379926 : }</span>
<a name="173"><span class="lineNum">     173 </span>            : </a>
<span class="lineNum">     174 </span>            : static void S_StopChannel(int cnum)
<span class="lineNum">     175 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :     int i;</span>
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :     channel_t *c;</span>
<span class="lineNum">     178 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :     c = &amp;channels[cnum];</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :     if (c-&gt;sfxinfo)</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :         // stop the sound playing</span>
<span class="lineNum">     184 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :         if (I_SoundIsPlaying(c-&gt;handle))</span>
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :         {</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :             I_StopSound(c-&gt;handle);</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :         // check to see if other channels are playing the sound</span>
<span class="lineNum">     191 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :         for (i=0; i&lt;snd_channels; i++)</span>
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :         {</span>
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :             if (cnum != i &amp;&amp; c-&gt;sfxinfo == channels[i].sfxinfo)</span>
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :             {</span>
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     199 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :         // degrade usefulness of sound data</span>
<span class="lineNum">     201 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :         c-&gt;sfxinfo-&gt;usefulness--;</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :         c-&gt;sfxinfo = NULL;</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :         c-&gt;origin = NULL;</span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     206 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     207 </span>            : 
<span class="lineNum">     208 </span>            : //
<span class="lineNum">     209 </span>            : // Per level startup code.
<span class="lineNum">     210 </span>            : // Kills playing sounds at start of level,
<span class="lineNum">     211 </span>            : //  determines music if any, changes music.
<span class="lineNum">     212 </span>            : //
<a name="213"><span class="lineNum">     213 </span>            : </a>
<span class="lineNum">     214 </span>            : void S_Start(void)
<span class="lineNum">     215 </span><span class="lineCov">       5494 : {</span>
<span class="lineNum">     216 </span><span class="lineCov">       5494 :     int cnum;</span>
<span class="lineNum">     217 </span><span class="lineCov">       5494 :     int mnum;</span>
<span class="lineNum">     218 </span><span class="lineCov">       5494 : </span>
<span class="lineNum">     219 </span><span class="lineCov">       5494 :     // kill all playing sounds at start of level</span>
<span class="lineNum">     220 </span><span class="lineCov">       5494 :     //  (trust me - a good idea)</span>
<span class="lineNum">     221 </span><span class="lineCov">      49446 :     for (cnum=0 ; cnum&lt;snd_channels ; cnum++)</span>
<span class="lineNum">     222 </span><span class="lineCov">      43952 :     {</span>
<span class="lineNum">     223 </span><span class="lineCov">      43952 :         if (channels[cnum].sfxinfo)</span>
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :         {</span>
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :             S_StopChannel(cnum);</span>
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     227 </span><span class="lineCov">      43952 :     }</span>
<span class="lineNum">     228 </span><span class="lineCov">       5494 : </span>
<span class="lineNum">     229 </span><span class="lineCov">       5494 :     // start new music for the level</span>
<span class="lineNum">     230 </span><span class="lineCov">       5494 :     mus_paused = 0;</span>
<span class="lineNum">     231 </span><span class="lineCov">       5494 : </span>
<span class="lineNum">     232 </span><span class="lineCov">       5494 :     if (gamemode == commercial)</span>
<span class="lineNum">     233 </span><span class="lineCov">       5494 :     {</span>
<span class="lineNum">     234 </span><span class="lineCov">       5494 :         mnum = mus_runnin + gamemap - 1;</span>
<span class="lineNum">     235 </span><span class="lineCov">       5494 :     }</span>
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :     else</span>
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :         int spmus[]=</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :         {</span>
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :             // Song - Who? - Where?</span>
<span class="lineNum">     241 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :             mus_e3m4,        // American     e4m1</span>
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :             mus_e3m2,        // Romero       e4m2</span>
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :             mus_e3m3,        // Shawn        e4m3</span>
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :             mus_e1m5,        // American     e4m4</span>
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :             mus_e2m7,        // Tim          e4m5</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :             mus_e2m4,        // Romero       e4m6</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :             mus_e2m6,        // J.Anderson   e4m7 CHIRON.WAD</span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :             mus_e2m5,        // Shawn        e4m8</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :             mus_e1m9,        // Tim          e4m9</span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :         };</span>
<span class="lineNum">     252 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :         if (gameepisode &lt; 4)</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :         {</span>
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :             mnum = mus_e1m1 + (gameepisode-1)*9 + gamemap-1;</span>
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :         else</span>
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :         {</span>
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :             mnum = spmus[gamemap-1];</span>
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     262 </span><span class="lineCov">       5494 : </span>
<span class="lineNum">     263 </span><span class="lineCov">       5494 :     S_ChangeMusic(mnum, true);</span>
<span class="lineNum">     264 </span><span class="lineCov">       5494 : }</span>
<a name="265"><span class="lineNum">     265 </span>            : </a>
<span class="lineNum">     266 </span>            : void S_StopSound(mobj_t *origin)
<span class="lineNum">     267 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :     int cnum;</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :     for (cnum=0 ; cnum&lt;snd_channels ; cnum++)</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :         if (channels[cnum].sfxinfo &amp;&amp; channels[cnum].origin == origin)</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :         {</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :             S_StopChannel(cnum);</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     279 </span>            : 
<span class="lineNum">     280 </span>            : //
<span class="lineNum">     281 </span>            : // S_GetChannel :
<span class="lineNum">     282 </span>            : //   If none available, return -1.  Otherwise channel #.
<span class="lineNum">     283 </span>            : //
<a name="284"><span class="lineNum">     284 </span>            : </a>
<span class="lineNum">     285 </span>            : static int S_GetChannel(mobj_t *origin, sfxinfo_t *sfxinfo)
<span class="lineNum">     286 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :     // channel number to use</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :     int                cnum;</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :     channel_t*        c;</span>
<span class="lineNum">     291 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :     // Find an open channel</span>
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :     for (cnum=0 ; cnum&lt;snd_channels ; cnum++)</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :         if (!channels[cnum].sfxinfo)</span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :         {</span>
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :         else if (origin &amp;&amp; channels[cnum].origin == origin)</span>
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :         {</span>
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :             S_StopChannel(cnum);</span>
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :     // None available</span>
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :     if (cnum == snd_channels)</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :         // Look for lower priority</span>
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :         for (cnum=0 ; cnum&lt;snd_channels ; cnum++)</span>
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :         {</span>
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :             if (channels[cnum].sfxinfo-&gt;priority &gt;= sfxinfo-&gt;priority)</span>
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :             {</span>
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     317 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :         if (cnum == snd_channels)</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :         {</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :             // FUCK!  No lower priority.  Sorry, Charlie.</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :             return -1;</span>
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :         else</span>
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :         {</span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :             // Otherwise, kick out lower priority.</span>
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :             S_StopChannel(cnum);</span>
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     329 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :     c = &amp;channels[cnum];</span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :     // channel is decided to be cnum.</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :     c-&gt;sfxinfo = sfxinfo;</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :     c-&gt;origin = origin;</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :     return cnum;</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     338 </span>            : 
<span class="lineNum">     339 </span>            : //
<span class="lineNum">     340 </span>            : // Changes volume and stereo-separation variables
<span class="lineNum">     341 </span>            : //  from the norm of a sound effect to be played.
<span class="lineNum">     342 </span>            : // If the sound is not audible, returns a 0.
<span class="lineNum">     343 </span>            : // Otherwise, modifies parameters and returns 1.
<span class="lineNum">     344 </span>            : //
<span class="lineNum">     345 </span>            : 
<a name="346"><span class="lineNum">     346 </span>            : static int S_AdjustSoundParams(mobj_t *listener, mobj_t *source,</a>
<span class="lineNum">     347 </span>            :                                int *vol, int *sep)
<span class="lineNum">     348 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :     fixed_t        approx_dist;</span>
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :     fixed_t        adx;</span>
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :     fixed_t        ady;</span>
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :     angle_t        angle;</span>
<span class="lineNum">     353 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :     // calculate the distance to sound origin</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :     //  and clip it if necessary</span>
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :     adx = abs(listener-&gt;x - source-&gt;x);</span>
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :     ady = abs(listener-&gt;y - source-&gt;y);</span>
<span class="lineNum">     358 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :     // From _GG1_ p.428. Appox. eucledian distance fast.</span>
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :     approx_dist = adx + ady - ((adx &lt; ady ? adx : ady)&gt;&gt;1);</span>
<span class="lineNum">     361 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :     if (gamemap != 8 &amp;&amp; approx_dist &gt; S_CLIPPING_DIST)</span>
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :     // angle of source to listener</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :     angle = R_PointToAngle2(listener-&gt;x,</span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :                             listener-&gt;y,</span>
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :                             source-&gt;x,</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :                             source-&gt;y);</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :     if (angle &gt; listener-&gt;angle)</span>
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :         angle = angle - listener-&gt;angle;</span>
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :     else</span>
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :         angle = angle + (0xffffffff - listener-&gt;angle);</span>
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     381 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :     angle &gt;&gt;= ANGLETOFINESHIFT;</span>
<span class="lineNum">     383 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :     // stereo separation</span>
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :     *sep = 128 - (FixedMul(S_STEREO_SWING, finesine[angle]) &gt;&gt; FRACBITS);</span>
<span class="lineNum">     386 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :     // volume calculation</span>
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :     if (approx_dist &lt; S_CLOSE_DIST)</span>
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :         *vol = snd_SfxVolume;</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :     else if (gamemap == 8)</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :         if (approx_dist &gt; S_CLIPPING_DIST)</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :         {</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :             approx_dist = S_CLIPPING_DIST;</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :         *vol = 15+ ((snd_SfxVolume-15)</span>
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :                     *((S_CLIPPING_DIST - approx_dist)&gt;&gt;FRACBITS))</span>
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :             / S_ATTENUATOR;</span>
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :     else</span>
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :         // distance effect</span>
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :         *vol = (snd_SfxVolume</span>
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :                 * ((S_CLIPPING_DIST - approx_dist)&gt;&gt;FRACBITS))</span>
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :             / S_ATTENUATOR;</span>
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     410 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :     return (*vol &gt; 0);</span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     413 </span>            : 
<span class="lineNum">     414 </span>            : // clamp supplied integer to the range 0 &lt;= x &lt;= 255.
<a name="415"><span class="lineNum">     415 </span>            : </a>
<span class="lineNum">     416 </span>            : static int Clamp(int x)
<span class="lineNum">     417 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :     if (x &lt; 0)</span>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :     else if (x &gt; 255)</span>
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :         return 255;</span>
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :     return x;</span>
<span class="lineNum">     427 </span><span class="lineNoCov">          0 : }</span>
<a name="428"><span class="lineNum">     428 </span>            : </a>
<span class="lineNum">     429 </span>            : void S_StartSound(void *origin_p, int sfx_id)
<span class="lineNum">     430 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :     sfxinfo_t *sfx;</span>
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :     mobj_t *origin;</span>
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :     int rc;</span>
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :     int sep;</span>
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :     int pitch;</span>
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :     int cnum;</span>
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :     int volume;</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :     origin = (mobj_t *) origin_p;</span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :     volume = snd_SfxVolume;</span>
<span class="lineNum">     441 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     442 </span><span class="lineNoCov">          0 :     // check for bogus sound #</span>
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :     if (sfx_id &lt; 1 || sfx_id &gt; NUMSFX)</span>
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :         I_Error(&quot;Bad sfx #: %d&quot;, sfx_id);</span>
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     447 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :     sfx = &amp;S_sfx[sfx_id];</span>
<span class="lineNum">     449 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :     // Initialize sound parameters</span>
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :     pitch = NORM_PITCH;</span>
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :     if (sfx-&gt;link)</span>
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :         volume += sfx-&gt;volume;</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :         pitch = sfx-&gt;pitch;</span>
<span class="lineNum">     456 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :         if (volume &lt; 1)</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :         {</span>
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :             return;</span>
<span class="lineNum">     460 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     461 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :         if (volume &gt; snd_SfxVolume)</span>
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :         {</span>
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :             volume = snd_SfxVolume;</span>
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     468 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :     // Check to see if it is audible,</span>
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :     //  and if not, modify the params</span>
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :     if (origin &amp;&amp; origin != players[consoleplayer].mo)</span>
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :         rc = S_AdjustSoundParams(players[consoleplayer].mo,</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :                                  origin,</span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :                                  &amp;volume,</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :                                  &amp;sep);</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :         if (origin-&gt;x == players[consoleplayer].mo-&gt;x</span>
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :          &amp;&amp; origin-&gt;y == players[consoleplayer].mo-&gt;y)</span>
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :         {</span>
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :             sep = NORM_SEP;</span>
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     483 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :         if (!rc)</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :         {</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :             return;</span>
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :     else</span>
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :         sep = NORM_SEP;</span>
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     493 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :     // hacks to vary the sfx pitches</span>
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :     if (sfx_id &gt;= sfx_sawup &amp;&amp; sfx_id &lt;= sfx_sawhit)</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :         pitch += 8 - (M_Random()&amp;15);</span>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :     else if (sfx_id != sfx_itemup &amp;&amp; sfx_id != sfx_tink)</span>
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :         pitch += 16 - (M_Random()&amp;31);</span>
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :     pitch = Clamp(pitch);</span>
<span class="lineNum">     504 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :     // kill old sound</span>
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :     S_StopSound(origin);</span>
<span class="lineNum">     507 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :     // try to find a channel</span>
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :     cnum = S_GetChannel(origin, sfx);</span>
<span class="lineNum">     510 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :     if (cnum &lt; 0)</span>
<span class="lineNum">     512 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     515 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :     // increase the usefulness</span>
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :     if (sfx-&gt;usefulness++ &lt; 0)</span>
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :         sfx-&gt;usefulness = 1;</span>
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :     if (sfx-&gt;lumpnum &lt; 0)</span>
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :         sfx-&gt;lumpnum = I_GetSfxLumpNum(sfx);</span>
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     526 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :     channels[cnum].pitch = pitch;</span>
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :     channels[cnum].handle = I_StartSound(sfx, cnum, volume, sep, channels[cnum].pitch);</span>
<span class="lineNum">     529 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     530 </span>            : 
<span class="lineNum">     531 </span>            : //
<span class="lineNum">     532 </span>            : // Stop and resume music, during game PAUSE.
<span class="lineNum">     533 </span>            : //
<a name="534"><span class="lineNum">     534 </span>            : </a>
<span class="lineNum">     535 </span>            : void S_PauseSound(void)
<span class="lineNum">     536 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     537 </span><span class="lineNoCov">          0 :     if (mus_playing &amp;&amp; !mus_paused)</span>
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :         I_PauseSong();</span>
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :         mus_paused = true;</span>
<span class="lineNum">     541 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     542 </span><span class="lineNoCov">          0 : }</span>
<a name="543"><span class="lineNum">     543 </span>            : </a>
<span class="lineNum">     544 </span>            : void S_ResumeSound(void)
<span class="lineNum">     545 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :     if (mus_playing &amp;&amp; mus_paused)</span>
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :         I_ResumeSong();</span>
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :         mus_paused = false;</span>
<span class="lineNum">     550 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     551 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     552 </span>            : 
<span class="lineNum">     553 </span>            : //
<span class="lineNum">     554 </span>            : // Updates music &amp; sounds
<span class="lineNum">     555 </span>            : //
<a name="556"><span class="lineNum">     556 </span>            : </a>
<span class="lineNum">     557 </span>            : void S_UpdateSounds(mobj_t *listener)
<span class="lineNum">     558 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     559 </span><span class="lineNoCov">          0 :     int                audible;</span>
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :     int                cnum;</span>
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :     int                volume;</span>
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :     int                sep;</span>
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :     sfxinfo_t*        sfx;</span>
<span class="lineNum">     564 </span><span class="lineNoCov">          0 :     channel_t*        c;</span>
<span class="lineNum">     565 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :     I_UpdateSound();</span>
<span class="lineNum">     567 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :     for (cnum=0; cnum&lt;snd_channels; cnum++)</span>
<span class="lineNum">     569 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :         c = &amp;channels[cnum];</span>
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :         sfx = c-&gt;sfxinfo;</span>
<span class="lineNum">     572 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :         if (c-&gt;sfxinfo)</span>
<span class="lineNum">     574 </span><span class="lineNoCov">          0 :         {</span>
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :             if (I_SoundIsPlaying(c-&gt;handle))</span>
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :             {</span>
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :                 // initialize parameters</span>
<span class="lineNum">     578 </span><span class="lineNoCov">          0 :                 volume = snd_SfxVolume;</span>
<span class="lineNum">     579 </span><span class="lineNoCov">          0 :                 sep = NORM_SEP;</span>
<span class="lineNum">     580 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     581 </span><span class="lineNoCov">          0 :                 if (sfx-&gt;link)</span>
<span class="lineNum">     582 </span><span class="lineNoCov">          0 :                 {</span>
<span class="lineNum">     583 </span><span class="lineNoCov">          0 :                     volume += sfx-&gt;volume;</span>
<span class="lineNum">     584 </span><span class="lineNoCov">          0 :                     if (volume &lt; 1)</span>
<span class="lineNum">     585 </span><span class="lineNoCov">          0 :                     {</span>
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :                         S_StopChannel(cnum);</span>
<span class="lineNum">     587 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :                     }</span>
<span class="lineNum">     589 </span><span class="lineNoCov">          0 :                     else if (volume &gt; snd_SfxVolume)</span>
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :                     {</span>
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :                         volume = snd_SfxVolume;</span>
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :                     }</span>
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     594 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :                 // check non-local sounds for distance clipping</span>
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :                 //  or modify their params</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :                 if (c-&gt;origin &amp;&amp; listener != c-&gt;origin)</span>
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :                 {</span>
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :                     audible = S_AdjustSoundParams(listener,</span>
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :                                                   c-&gt;origin,</span>
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :                                                   &amp;volume,</span>
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :                                                   &amp;sep);</span>
<span class="lineNum">     603 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :                     if (!audible)</span>
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :                     {</span>
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :                         S_StopChannel(cnum);</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :                     }</span>
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :                     else</span>
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :                     {</span>
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :                         I_UpdateSoundParams(c-&gt;handle, volume, sep);</span>
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :                     }</span>
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :             else</span>
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :             {</span>
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :                 // if channel is allocated but sound has stopped,</span>
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :                 //  free it</span>
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :                 S_StopChannel(cnum);</span>
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     621 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     622 </span><span class="lineNoCov">          0 : }</span>
<a name="623"><span class="lineNum">     623 </span>            : </a>
<span class="lineNum">     624 </span>            : void S_SetMusicVolume(int volume)
<span class="lineNum">     625 </span><span class="lineCov">       5494 : {</span>
<span class="lineNum">     626 </span><span class="lineCov">       5494 :     if (volume &lt; 0 || volume &gt; 127)</span>
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :         I_Error(&quot;Attempt to set music volume at %d&quot;,</span>
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :                 volume);</span>
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     631 </span><span class="lineCov">       5494 : </span>
<span class="lineNum">     632 </span><span class="lineCov">       5494 :     I_SetMusicVolume(volume);</span>
<span class="lineNum">     633 </span><span class="lineCov">       5494 : }</span>
<a name="634"><span class="lineNum">     634 </span>            : </a>
<span class="lineNum">     635 </span>            : void S_SetSfxVolume(int volume)
<span class="lineNum">     636 </span><span class="lineCov">       5494 : {</span>
<span class="lineNum">     637 </span><span class="lineCov">       5494 :     if (volume &lt; 0 || volume &gt; 127)</span>
<span class="lineNum">     638 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :         I_Error(&quot;Attempt to set sfx volume at %d&quot;, volume);</span>
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     641 </span><span class="lineCov">       5494 : </span>
<span class="lineNum">     642 </span><span class="lineCov">       5494 :     snd_SfxVolume = volume;</span>
<span class="lineNum">     643 </span><span class="lineCov">       5494 : }</span>
<span class="lineNum">     644 </span>            : 
<span class="lineNum">     645 </span>            : //
<span class="lineNum">     646 </span>            : // Starts some music with the music id found in sounds.h.
<span class="lineNum">     647 </span>            : //
<a name="648"><span class="lineNum">     648 </span>            : </a>
<span class="lineNum">     649 </span>            : void S_StartMusic(int m_id)
<span class="lineNum">     650 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :     S_ChangeMusic(m_id, false);</span>
<span class="lineNum">     652 </span><span class="lineNoCov">          0 : }</span>
<a name="653"><span class="lineNum">     653 </span>            : </a>
<span class="lineNum">     654 </span>            : void S_ChangeMusic(int musicnum, int looping)
<span class="lineNum">     655 </span><span class="lineCov">       5494 : {</span>
<span class="lineNum">     656 </span><span class="lineCov">       5494 :     musicinfo_t *music = NULL;</span>
<span class="lineNum">     657 </span><span class="lineCov">       5494 :     char namebuf[9];</span>
<span class="lineNum">     658 </span><span class="lineCov">       5494 :     void *handle;</span>
<span class="lineNum">     659 </span><span class="lineCov">       5494 : </span>
<span class="lineNum">     660 </span><span class="lineCov">       5494 :     // The Doom IWAD file has two versions of the intro music: d_intro</span>
<span class="lineNum">     661 </span><span class="lineCov">       5494 :     // and d_introa.  The latter is used for OPL playback.</span>
<span class="lineNum">     662 </span><span class="lineCov">       5494 : </span>
<span class="lineNum">     663 </span><span class="lineCov">       5494 :     if (musicnum == mus_intro &amp;&amp; (snd_musicdevice == SNDDEVICE_ADLIB</span>
<span class="lineNum">     664 </span><span class="lineNoCov">          0 :                                || snd_musicdevice == SNDDEVICE_SB)</span>
<span class="lineNum">     665 </span><span class="lineCov">       5494 :         &amp;&amp; W_CheckNumForName(&quot;D_INTROA&quot;) &gt;= 0)</span>
<span class="lineNum">     666 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :         musicnum = mus_introa;</span>
<span class="lineNum">     668 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     669 </span><span class="lineCov">       5494 : </span>
<span class="lineNum">     670 </span><span class="lineCov">       5494 :     if (musicnum &lt;= mus_None || musicnum &gt;= NUMMUSIC)</span>
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :         I_Error(&quot;Bad music number %d&quot;, musicnum);</span>
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     674 </span><span class="lineCov">       5494 :     else</span>
<span class="lineNum">     675 </span><span class="lineCov">       5494 :     {</span>
<span class="lineNum">     676 </span><span class="lineCov">       5494 :         music = &amp;S_music[musicnum];</span>
<span class="lineNum">     677 </span><span class="lineCov">       5494 :     }</span>
<span class="lineNum">     678 </span><span class="lineCov">       5494 : </span>
<span class="lineNum">     679 </span><span class="lineCov">       5494 :     if (mus_playing == music)</span>
<span class="lineNum">     680 </span><span class="lineCov">       5462 :     {</span>
<span class="lineNum">     681 </span><span class="lineCov">       5462 :         return;</span>
<span class="lineNum">     682 </span><span class="lineCov">       5462 :     }</span>
<span class="lineNum">     683 </span><span class="lineCov">         32 : </span>
<span class="lineNum">     684 </span><span class="lineCov">         32 :     // shutdown old music</span>
<span class="lineNum">     685 </span><span class="lineCov">         32 :     S_StopMusic();</span>
<span class="lineNum">     686 </span><span class="lineCov">         32 : </span>
<span class="lineNum">     687 </span><span class="lineCov">         32 :     // get lumpnum if neccessary</span>
<span class="lineNum">     688 </span><span class="lineCov">         32 :     if (!music-&gt;lumpnum)</span>
<span class="lineNum">     689 </span><span class="lineCov">         32 :     {</span>
<span class="lineNum">     690 </span><span class="lineCov">         32 :         M_snprintf(namebuf, sizeof(namebuf), &quot;d_%s&quot;, DEH_String(music-&gt;name));</span>
<span class="lineNum">     691 </span><span class="lineCov">         32 :         music-&gt;lumpnum = W_GetNumForName(namebuf);</span>
<span class="lineNum">     692 </span><span class="lineCov">         32 :     }</span>
<span class="lineNum">     693 </span><span class="lineCov">         32 : </span>
<span class="lineNum">     694 </span><span class="lineCov">         32 :     music-&gt;data = W_CacheLumpNum(music-&gt;lumpnum, PU_STATIC);</span>
<span class="lineNum">     695 </span><span class="lineCov">         32 : </span>
<span class="lineNum">     696 </span><span class="lineCov">         32 :     handle = I_RegisterSong(music-&gt;data, W_LumpLength(music-&gt;lumpnum));</span>
<span class="lineNum">     697 </span><span class="lineCov">         32 :     music-&gt;handle = handle;</span>
<span class="lineNum">     698 </span><span class="lineCov">         32 :     I_PlaySong(handle, looping);</span>
<span class="lineNum">     699 </span><span class="lineCov">         32 : </span>
<span class="lineNum">     700 </span><span class="lineCov">         32 :     mus_playing = music;</span>
<span class="lineNum">     701 </span><span class="lineCov">         32 : }</span>
<a name="702"><span class="lineNum">     702 </span>            : </a>
<span class="lineNum">     703 </span>            : boolean S_MusicPlaying(void)
<span class="lineNum">     704 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :     return I_MusicIsPlaying();</span>
<span class="lineNum">     706 </span><span class="lineNoCov">          0 : }</span>
<a name="707"><span class="lineNum">     707 </span>            : </a>
<span class="lineNum">     708 </span>            : void S_StopMusic(void)
<span class="lineNum">     709 </span><span class="lineCov">         32 : {</span>
<span class="lineNum">     710 </span><span class="lineCov">         32 :     if (mus_playing)</span>
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :         if (mus_paused)</span>
<span class="lineNum">     713 </span><span class="lineNoCov">          0 :         {</span>
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :             I_ResumeSong();</span>
<span class="lineNum">     715 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     716 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     717 </span><span class="lineNoCov">          0 :         I_StopSong();</span>
<span class="lineNum">     718 </span><span class="lineNoCov">          0 :         I_UnRegisterSong(mus_playing-&gt;handle);</span>
<span class="lineNum">     719 </span><span class="lineNoCov">          0 :         W_ReleaseLumpNum(mus_playing-&gt;lumpnum);</span>
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :         mus_playing-&gt;data = NULL;</span>
<span class="lineNum">     721 </span><span class="lineNoCov">          0 :         mus_playing = NULL;</span>
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     723 </span><span class="lineCov">         32 : }</span>
<span class="lineNum">     724 </span>            : 
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
